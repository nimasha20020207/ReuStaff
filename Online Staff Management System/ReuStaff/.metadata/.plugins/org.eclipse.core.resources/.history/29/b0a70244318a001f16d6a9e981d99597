package SMS;

import java.io.IOException;
import java.util.ArrayList;
import java.util.List;
import jakarta.servlet.RequestDispatcher;
import jakarta.servlet.ServletException;
import jakarta.servlet.annotation.WebServlet;
import jakarta.servlet.http.HttpServlet;
import jakarta.servlet.http.HttpServletRequest;
import jakarta.servlet.http.HttpServletResponse;
import jakarta.servlet.http.HttpSession;

@WebServlet("/")
public class SMScontroller extends HttpServlet{
    PayrollDAO dao=new PayrollDAO();
	
    //handle get requests
	public void doGet(HttpServletRequest req,HttpServletResponse res) throws IOException, ServletException {
		String act=req.getServletPath();
		
		//switch between different actions based on the url path
		switch(act) {
			case "/PayslipForm":
				checkPaySlip(req,res);
				System.out.println("Issue Payslip"+act);
				break;
			case "/paySlipRecord":
				showPaySlips(req,res);
				System.out.println("viewd slip inbox"+act);
				break;
			case"/update":
				showUpdateForm(req,res);
				System.out.println("viewdUpdatingForm"+act);
				break;
				
			case"/updateCatch":
				updateCatch(req,res);
				System.out.println("FormUpdated"+act);
				break;
				
			case"/deleteSlip":
				deleteSlip(req,res);
				System.out.println("payslipDeleted");
				break;
			   
	}
	}
	
		//method to delete a pay slip
		private void deleteSlip(HttpServletRequest req, HttpServletResponse res) throws IOException {
			
			int id=Integer.parseInt(req.getParameter("id"));//get pay slip ID from request
			dao.delete(id);//delete pay slip using data access object
			
			System.out.println("slip deleted");//verifying whether the pay slip deleted or not
			res.sendRedirect("paySlipRecord");//redirect back to pay slip record page
			
		
		}

		//method to handle updating a pay slip
		private void updateCatch(HttpServletRequest req, HttpServletResponse res) throws IOException {
			
			int id=Integer.parseInt(req.getParameter("PayID"));
			String staffmemID=req.getParameter("staffID");
			String month=req.getParameter("month");
			float Bonus=Float.parseFloat(req.getParameter("bonusAmount"));
			float Basic=Float.parseFloat(req.getParameter("basicAmount"));
			float Total=Float.parseFloat(req.getParameter("salaryTotal"));
			String payrollOfficerID=req.getParameter("issuedBy");
			
			//create a new pay slip object with updated values
			paySlip updatedSlip=new paySlip(id,staffmemID,month,Bonus,Basic,Total,payrollOfficerID);
			//update the pay slip using data access object
			boolean check=dao.updatePaySlip(updatedSlip);
			
			if(check) {
				res.sendRedirect("payrollPaySlip.jsp");
			}
			else {
				System.out.println("failed to update");
			}
	}

		//method to show pay slip updating form
		private void showUpdateForm(HttpServletRequest req, HttpServletResponse res) throws ServletException, IOException {
		
			int id=Integer.parseInt(req.getParameter("id"));
			paySlip slip=dao.selectUpdateSlip(id);
			RequestDispatcher rd=req.getRequestDispatcher("update.jsp");
			System.out.println(slip);
			req.setAttribute("pslip",slip);
			rd.forward(req, res);
		
	}

		//method to show issued pay slip records
		private void showPaySlips(HttpServletRequest req, HttpServletResponse res) throws ServletException, IOException {
		List<paySlip> pList=new ArrayList<>();
		
		pList=dao.getIssuedPayslips();
		req.setAttribute("pt", pList);
		System.out.println(pList);
		RequestDispatcher rd=req.getRequestDispatcher("paySlipRecord.jsp");
		rd.forward(req, res);
	}
		
		
		//method to issue a new pay slip
		private void checkPaySlip(HttpServletRequest req, HttpServletResponse res) throws IOException {
			
			//catching form data
			int pid=Integer.parseInt(req.getParameter("PayID"));
			String ID=req.getParameter("staffID");
			String Month=req.getParameter("month");
			float bonus=Float.parseFloat(req.getParameter("bonusAmount"));
			float basic=Float.parseFloat(req.getParameter("basicAmount"));
			float total= Float.parseFloat(req.getParameter("salaryTotal"));
			String payrollOfficer=req.getParameter("issuedBy");
			
			//create a new pay slip object with given data
			paySlip ps=new paySlip(pid,ID,Month,bonus,basic,total,payrollOfficer);
		
			dao.addNewPayslip(ps);//add the new pay slip using data access object
			System.out.println("Payslip added to system");//verifying whether pay slip added to the system or not
			res.sendRedirect("payrollPaySlip.jsp");//re direct to the pay slip issuing page
			
			
			
		}



}
